{"version":3,"sources":["../src/deploy.js"],"names":["loginFile","path","join","process","cwd","module","exports","execute","context","deploy","err","config","credentials","ignore","ignoredFiles","fs","readFileSync","defaultConfig","JSON","parse","e","console","log","exit","filter","ignoredFile","match","map","rimraf","sync","ensureDir","copy","sourceDirectory","error","client","s3sync","region","s3region","accessKeyId","key","secretAccessKey","secret","TransferMonitor","monitor","on","progress","s3bucket","s3prefix","commandInput","ACL","del"],"mappings":"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","sourcesContent":["import s3sync from 's3-sync-client';\r\nimport path from 'path';\r\nimport prompt from 'prompt';\r\nimport fs from 'fs-extra';\r\nimport * as _ from 'lodash';\r\nimport rimraf from 'rimraf';\r\n\r\nconst loginFile = path.join(process.cwd(), '.chcplogin');\r\n\r\n(function () {\r\n    module.exports = {\r\n        execute: execute,\r\n    };\r\n\r\n    async function execute(context) {\r\n        try {\r\n            await deploy(context);\r\n        } catch (err) {\r\n            throw err;\r\n        }\r\n    }\r\n\r\n    async function deploy(context) {\r\n        let config;\r\n        let credentials;\r\n        let ignore = context.ignoredFiles;\r\n\r\n        try {\r\n            config = fs.readFileSync(context.defaultConfig, 'utf8');\r\n            config = JSON.parse(config);\r\n        } catch (e) {\r\n            console.log(\r\n                'Cannot parse cordova-hcp.json. Did you run cordova-hcp init?'\r\n            );\r\n            process.exit(0);\r\n        }\r\n        if (!config) {\r\n            console.log(\r\n                'You need to run \"cordova-hcp init\" before you can run \"cordova-hcp login\".'\r\n            );\r\n            console.log(\r\n                'Both commands needs to be invoked in the root of the project directory.'\r\n            );\r\n            process.exit(0);\r\n        }\r\n        try {\r\n            credentials = fs.readFileSync(loginFile, 'utf8');\r\n            credentials = JSON.parse(credentials);\r\n        } catch (e) {\r\n            console.log('Cannot parse .chcplogin: ', e);\r\n        }\r\n        if (!credentials) {\r\n            console.log(\r\n                'You need to run \"cordova-hcp login\" before you can run \"cordova-hcp deploy\".'\r\n            );\r\n            process.exit(0);\r\n        }\r\n\r\n        ignore = ignore.filter((ignoredFile) => !ignoredFile.match(/^chcp/));\r\n        ignore = ignore.map((ignoredFile) => `!${ignoredFile}`);\r\n\r\n        // console.log('Credentials: ', credentials);\r\n        // console.log('Config: ', config);\r\n        // console.log('Ignore: ', ignore);\r\n\r\n        try {\r\n            rimraf.sync('./s3sync');\r\n            await fs.ensureDir('./s3sync');\r\n        } catch (err) {\r\n            throw err;\r\n        }\r\n\r\n        try {\r\n            await fs.copy(context.sourceDirectory, './s3sync');\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n\r\n        const client = new s3sync({\r\n            region: config.s3region,\r\n            credentials: {\r\n                accessKeyId: credentials.key,\r\n                secretAccessKey: credentials.secret,\r\n            },\r\n        });\r\n        const { TransferMonitor } = s3sync;\r\n        const monitor = new TransferMonitor();\r\n        monitor.on('progress', (progress) => console.log(progress));\r\n        try {\r\n            await client.sync(\r\n                './s3sync',\r\n                `s3://${config.s3bucket}/${config.s3prefix}`,\r\n                {\r\n                    commandInput: {\r\n                        ACL: 'public-read',\r\n                    },\r\n                    monitor: monitor,\r\n                    del: true,\r\n                }\r\n            );\r\n            console.log(\r\n                'Deploy complete',\r\n                `s3://${config.s3bucket}/${config.s3prefix}`\r\n            );\r\n        } catch (err) {\r\n            throw err;\r\n        }\r\n    }\r\n})();\r\n"],"file":"deploy.js"}